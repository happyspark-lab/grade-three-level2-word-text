<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸‰å¹´çº§ä¸‹å†Œ Â· è¯è¯­é—¯å…³</title>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        :root {
            /* ä¸‰å¹´çº§é…è‰²ï¼šæ›´æ´»æ³¼çš„ç¿ ç»¿è‰²è°ƒ */
            --primary: #10b981; 
            --primary-dark: #047857;
            --bg-gradient: linear-gradient(135deg, #ecfdf5 0%, #f0fdf4 100%);
            --card-bg: rgba(255, 255, 255, 0.95);
            --text: #064e3b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Microsoft YaHei", sans-serif;
            background: var(--bg-gradient);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center; 
            padding: 15px;
        }

        .container {
            background: var(--card-bg);
            border-radius: 24px;
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.15);
            width: 100%;
            max-width: 600px;
            padding: 25px 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            border: 1px solid rgba(255,255,255,0.6);
            backdrop-filter: blur(10px);
            position: relative;
        }

        header { text-align: center; margin-bottom: 5px; }
        .header-badge {
            background: #d1fae5; color: var(--primary-dark); font-size: 0.85rem;
            padding: 4px 12px; border-radius: 20px; display: inline-block;
            margin-bottom: 8px; font-weight: bold; border: 1px solid #6ee7b7;
        }
        h1 { 
            color: var(--primary); font-size: 1.6rem; margin: 0; 
            text-shadow: 1px 1px 0px rgba(209, 250, 229, 0.5);
        }

        .motivation-box {
            background: linear-gradient(to right, #ecfdf5, #f0fdf4);
            border-left: 4px solid #34d399;
            padding: 12px;
            border-radius: 8px;
            color: #065f46;
            font-size: 0.95rem;
            text-align: center;
            font-weight: bold;
            min-height: 48px;
            display: flex; align-items: center; justify-content: center;
        }

        .setup-panel {
            border: 2px dashed #6ee7b7; border-radius: 16px; padding: 20px;
            background: #fff; transition: all 0.3s;
        }

        .lesson-select {
            width: 100%; padding: 12px; font-size: 1.05rem;
            border: 2px solid var(--primary); border-radius: 10px;
            background: white; font-weight: bold; outline: none;
            color: #047857; margin-bottom: 5px;
        }

        .preview-list {
            display: block;
            margin-top: 16px;
            max-height: 220px;
            overflow-y: auto;
            text-align: left;
            background: #ecfdf5;
            padding: 15px;
            border-radius: 12px;
            border: 2px solid #d1fae5;
        }

        .settings-row {
            display: flex; gap: 8px; justify-content: space-between; margin: 15px 0;
        }
        .setting-group { 
            flex: 1; text-align: center; background: #f0fdf4;
            padding: 8px 5px; border-radius: 8px; border: 1px solid #d1fae5;
        }
        .setting-group label { display: block; font-size: 0.75rem; color: #64748b; margin-bottom: 3px;}
        select { 
            width: 100%; border: none; background: transparent; 
            font-weight: bold; color: #334155; text-align: center; font-size: 0.95rem;
        }

        .main-btn {
            background: linear-gradient(to bottom right, #10b981, #059669);
            color: white; border: none; padding: 16px; border-radius: 50px;
            font-size: 1.3rem; font-weight: 800; width: 100%;
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .main-btn:active { transform: scale(0.98); }

        /* Running UI */
        .running-ui { display: none; text-align: center; padding: 10px 0; }
        .level-badge {
            background: #34d399; color: white; padding: 4px 10px;
            border-radius: 12px; font-size: 0.8rem; font-weight: bold;
            display: inline-block; margin-bottom: 10px;
        }

        .big-word-display {
            font-size: 3.5rem; font-weight: 800; color: var(--text);
            margin: 15px 0; min-height: 80px; font-family: "KaiTi", "æ¥·ä½“", serif;
        }

        .progress-container {
            height: 12px; background: #e2e8f0; border-radius: 10px;
            overflow: hidden; margin: 15px 0;
        }
        .progress-fill {
            height: 100%; background: linear-gradient(90deg, #34d399, #10b981);
            width: 0%; transition: width 0.3s ease-out;
        }

        .control-btns { display: flex; justify-content: center; gap: 15px; margin-top: 25px;}
        .control-btn {
            padding: 10px 20px; border-radius: 10px; border: none;
            font-weight: bold; font-size: 0.95rem;
        }
        .btn-pause { background: #ecfdf5; color: #047857; border: 1px solid #6ee7b7; }
        .btn-stop { background: #fef2f2; color: #b91c1c; border: 1px solid #fecaca; }

        .answer-list {
            margin-top: 20px; text-align: left; background: #ecfdf5;
            padding: 15px; border-radius: 12px; display: none; border: 2px solid #d1fae5;
        }
        .answer-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px;
        }
        .answer-item {
            background: white; padding: 10px 2px; border-radius: 8px;
            text-align: center; font-size: 2rem; font-weight: bold;
            color: #047857; border-bottom: 2px solid #6ee7b7;
        }

        .expand-toggle { text-align: center; color: #94a3b8; font-size: 0.8rem; margin-top: 15px; padding: 10px;}
        #customInputArea { display: none; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #eee;}
        textarea { width: 100%; height: 80px; padding: 8px; border: 1px solid #ddd; border-radius: 8px; }

        @keyframes popIn { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .ios-tip { font-size: 0.75rem; color: #ef4444; background: #fee2e2; padding: 8px; border-radius: 8px; margin-bottom: 10px; text-align: left; display: none;}
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="header-badge">ğŸŒ¿ ä¸‰å¹´çº§ä¸‹å†Œ ğŸŒ¿</div>
        <h1>è¯è¯­å¤§é—¯å…³</h1>
    </header>
    
    <div id="iosTip" class="ios-tip">
        ğŸ“± <b>iPhoneç”¨æˆ·æç¤ºï¼š</b>è¯·æ‹¨å¼€ä¾§è¾¹é™éŸ³é”®ï¼Œå¹¶è°ƒå¤§åª’ä½“éŸ³é‡ã€‚
    </div>

    <div class="motivation-box" id="motivationBox">
        å‡†å¤‡å¥½äº†å—ï¼Ÿå­—å†™å¾—æ¼‚äº®ï¼Œäººä¹Ÿæ›´ç²¾ç¥ï¼
    </div>

    <div id="setupArea" class="setup-panel">
        <label style="display:block; margin-bottom:5px; font-weight:bold; color:#047857; font-size:0.9rem;">ğŸ“š é€‰æ‹©è¯¾æ–‡ï¼š</label>
        <select id="lessonSelect" class="lesson-select" onchange="previewWords()"></select>

        <div class="settings-row">
            <div class="setting-group">
                <label>ğŸ—£ï¸ è¯­é€Ÿ</label>
                <select id="speechRate">
                    <option value="1">æ­£å¸¸</option>
                    <option value="0.8">ç¨æ…¢</option>
                    <option value="0.6" selected>è¾ƒæ…¢</option>
                    <option value="0.5">å¾ˆæ…¢</option>
                </select>
            </div>
            <div class="setting-group">
                <label>ğŸ” é‡å¤</label>
                <select id="repeatCount">
                    <option value="1">1æ¬¡</option>
                    <option value="2" selected>2æ¬¡</option>
                    <option value="3">3æ¬¡</option>
                </select>
            </div>
            <div class="setting-group">
                <label>âœï¸ ä¹¦å†™</label>
                <select id="waitTime">
                    <option value="5">5ç§’</option>
                    <option value="8" selected>8ç§’</option>
                    <option value="12">12ç§’</option>
                </select>
            </div>
        </div>

        <button class="main-btn" onclick="initDictation()">
            <span>ğŸš€ å¼€å§‹æŒ‘æˆ˜</span>
        </button>

        <div id="wordPreview" class="preview-list"></div>

        <div class="expand-toggle" onclick="toggleCustomArea()">+ è‡ªå®šä¹‰ / PDFè¯†åˆ«</div>
        <div id="customInputArea">
             <textarea id="customWordInput" placeholder="åœ¨æ­¤ç²˜è´´è¯è¯­..."></textarea>
             <input type="file" accept="application/pdf" onchange="handlePdfUpload(event)" style="margin-top:8px; width:100%">
             <div id="ocrStatus" style="font-size:0.8rem; color:green; margin-top:5px;"></div>
        </div>
    </div>

    <div id="runningArea" class="running-ui">
        <span class="level-badge" id="currentLevelName">å½“å‰å…³å¡</span>
        
        <div class="progress-container">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="progress-text" id="progressText" style="font-size:0.8rem; color:#888;">0 / 0</div>

        <div class="big-word-display" id="wordDisplay">Ready</div>
        <div style="color: #64748b; font-size: 0.9rem;" id="statusMsg">ç‚¹å‡»å¼€å§‹</div>

        <div class="control-btns">
            <button class="control-btn btn-pause" id="pauseBtn" onclick="togglePause()">æš‚åœ</button>
            <button class="control-btn btn-stop" onclick="stopDictation()">ç»“æŸ</button>
        </div>

        <div class="answer-list" id="answerList"></div>
    </div>
</div>

<script>
    // --- ä¸‰å¹´çº§ä¸‹å†Œ æ•°æ®åŒº ---
    const lessonGroups = [
        { 
            name: "ç¬¬1è¯¾ï¼šå¤è¯—ä¸‰é¦–", 
            words: ["èåŒ–", "ç‡•å­", "é¸³é¸¯", "æ©æƒ ", "å´‡é«˜", "èŠ¦è‹‡", "å‘èŠ½", "æ¢…èŠ±", "å°æºª", "æ³›èˆŸ", "å‡å°‘"] 
        },
        { 
            name: "ç¬¬2è¯¾ï¼šç‡•å­", 
            words: ["å‡‘åˆ", "å¹æ‹‚", "é›†åˆ", "èšé›†", "å½¢çŠ¶", "æ è¿‡", "å¶å°”", "æ²¾æ°´", "ç–²å€¦", "ç©ºé—²", "çº¤ç»†", "ç—•è¿¹", "ä¹Œé»‘", "æ´»æ³¼", "æ˜¥æ—¥", "è½»é£", "æ´’è½", "èµ¶é›†", "èšæ‹¢", "å½¢æˆ", "åŠ å…¥", "æ˜¥å…‰", "æ¹–é¢", "é—²æ•£"] 
        },
        { 
            name: "ç¬¬3è¯¾ï¼šè·èŠ±", 
            words: ["èŠ±ç“£", "è²è“¬", "é¥±èƒ€", "ç ´è£‚", "å§¿åŠ¿", "ä»¿ä½›", "éšé£", "èˆè¹ˆ", "åœæ­¢", "è·èŠ±", "æ¸…é¦™", "åœ†ç›˜", "çœ¼å‰", "æœ¬é¢†", "é£˜åŠ¨"] 
        },
        { 
            name: "ç¬¬5è¯¾ï¼šå®ˆæ ªå¾…å…”", 
            words: ["å®ˆå€™", "æ¤æ ª", "ç­‰å¾…", "å®‹æœ", "è€•åœ°", "æ¥è§¦", "é¢ˆéƒ¨", "è§£é‡Š", "å…¶ä»–"] 
        },
        { 
            name: "ç¬¬6è¯¾ï¼šé™¶ç½å’Œé“ç½", 
            words: ["éª„å‚²", "è°¦è™š", "æ‡¦å¼±", "ææ°´", "å°˜åœŸ", "æƒŠè®¶", "æ§ç€", "å¤ä»£", "ä»·å€¼", "å›½ç‹", "å‚²æ…¢", "ç¥æ°”", "ä½å˜´", "ç›¸æå¹¶è®º", "ç‹æœ", "å…‰æ´", "ç¾è§‚", "åŠ¨æ‰‹"] 
        },
        { 
            name: "ç¬¬7è¯¾ï¼šé¹¿è§’å’Œé¹¿è…¿", 
            words: ["æ¢…èŠ±é¹¿", "æ± å¡˜", "å€’æ˜ ", "æ¬£èµ", "åŒ€ç§°", "åˆ«è‡´", "é…åˆ", "ä¼ è¯´", "å“å‘€", "ç‹®å­", "è¿½èµ¶", "å¹æ°”", "ç—›å¿«", "ç²¾ç¾", "æ²¡ç²¾æ‰“é‡‡", "æœºçµ", "æœºä¼š"] 
        },
        { 
            name: "ç¬¬9è¯¾ï¼šå¤è¯—ä¸‰é¦–", 
            words: ["ç¬¦å·", "æ¬²æœ›", "çµé­‚", "å€Ÿå£", "å–é…’", "ä½•å¤„", "ç‰§ç«¥", "å…„å¼Ÿ", "ç‹¬è‡ª", "å¼‚ä¹¡", "ä½³èŠ‚"] 
        },
        { 
            name: "ç¬¬10è¯¾ï¼šçº¸çš„å‘æ˜", 
            words: ["ä¼Ÿå¤§", "è®°å½•", "ä¿å­˜", "å¤§çº¦", "ç»éªŒ", "æ‰“æ", "é˜¿å§¨", "æ¬§æ´²", "ç¤¾ä¼š", "é€ çº¸æœ¯", "å¸æ”¶", "åŸæ–™", "æ»¡è¶³", "æœé²œ", "åŠå²›", "æ—¥æœ¬", "é˜¿æ‹‰ä¼¯"] 
        },
        { 
            name: "ç¬¬11è¯¾ï¼šèµµå·æ¡¥", 
            words: ["èµµå·æ¡¥", "çœç•¥", "å¿åŸ", "çŸ³åŒ ", "è®¾è®¡", "å†å²", "åˆ›ä¸¾", "è€Œä¸”", "æ™ºæ…§", "ç»å†", "å†²å‡»", "èŠ‚çœ", "ä¸ä½†", "å„è‡ª", "ä¼¼ä¹", "ä½“ç°", "äººæ°‘", "æ‰å¹²"] 
        },
        { 
            name: "ç¬¬12è¯¾ï¼šä¸€å¹…åæ‰¬ä¸­å¤–çš„ç”»", 
            words: ["é€‰æ‹©", "çš‡å®«", "æ‘Šä½", "å°è´©", "å®˜å", "æ¯›é©´", "ä¹˜å®¢", "ç¯ç¬¼", "æ æ†", "ç¤¼è²Œ"] 
        },
        { 
            name: "ç¬¬13è¯¾ï¼šèŠ±é’Ÿ", 
            words: ["èŠ¬èŠ³", "å†…å­˜", "é†’æ¥", "é•¿å¯¿", "è‹é†’", "å¼ºå¤§", "å±•ç¤º", "æ˜†è™«", "ä¿®å»º", "ç»„æˆ", "äº‰å¥‡æ–—è‰³", "è¿·äºº", "è‰³ä¸½", "ç¡è²", "ä¸‡å¯¿èŠ", "æ¬£ç„¶", "å«ç¬‘"] 
        },
        { 
            name: "ç¬¬14è¯¾ï¼šèœœèœ‚", 
            words: ["èœœèœ‚", "è¾¨è®¤", "é˜»åŠ›", "è·¨è¶Š", "åŒ…æ‹¬", "æ£€æŸ¥", "å‡†ç¡®", "é”™è¯¯", "æ²¿é€”", "é™Œç”Ÿ", "èƒ½åŠ›", "å°†è¿‘", "è¿·å¤±", "æ— è¯¯", "å°½ç®¡", "ç¡®å®", "è®°å¿†", "æœ¬èƒ½"] 
        },
        { 
            name: "ç¬¬16è¯¾ï¼šå®‡å®™çš„å¦ä¸€è¾¹", 
            words: ["å®‡å®™", "æ·Œæ°´", "ç§˜å¯†", "ä¸€æ ‹", "æ¥¼æ¢¯", "é“ƒå£°", "ä¹˜æ³•", "æƒ…ç»ª", "ä¸€ç¯‡", "è¶Šè¿‡", "æ˜Ÿç©º", "æµæ·Œ", "ç›¸é‡", "ä¸‡ç‰©", "ä¹˜æ³•", "æ€ç»ª"] 
        },
        { 
            name: "ç¬¬17è¯¾ï¼šæˆ‘å˜æˆäº†ä¸€æ£µæ ‘", 
            words: ["å½¢çŠ¶", "ç‹ç‹¸", "å¼¯è…°", "é›¶é£Ÿ", "å·§å…‹åŠ›", "é¦™è‚ ", "ç»§ç»­", "æŠ¬å¤´", "éº»çƒ¦", "æ‹…å¿ƒ", "ä¸é›¶", "å¤±æœ›", "èƒŒåŒ…", "èŠ±ç”Ÿ", "ç‰›å¥¶", "é¥­èœ", "æ’éª¨"] 
        },
        { 
            name: "ç¬¬18è¯¾ï¼šç«¥å¹´çš„æ°´å¢¨ç”»", 
            words: ["å¢¨æ°´", "æŸ“ç»¿", "ç«¹ç«¿", "å¥”è…¾", "ç ´ç¢", "æ‹¨åŠ¨", "æµªèŠ±", "è‘«èŠ¦", "æ¸…çˆ½", "è˜‘è‡", "æ°´å¢¨ç”»", "å‚æŸ³", "é’“ç«¿", "æ‰‘è…¾", "æ‰‡åŠ¨", "æˆè€", "æ¾æ ‘", "æ¾é’ˆ"] 
        },
        { 
            name: "ç¬¬19è¯¾ï¼šå‰ƒå¤´å¤§å¸ˆ", 
            words: ["è¡¨ç¤º", "èƒ†å°", "é¬¼æ€ª", "ç†å‘", "å¤ºèµ°", "è´£éª‚", "ä»‡äºº", "å·®åˆ«", "ä»˜å‡º", "åŠ å€", "è™½ç„¶", "è‚¥çš‚æ³¡", "æ¡ä»¶", "å¤§å¸ˆ", "è¡¨å¼Ÿ", "å§‘çˆ¶", "æ¬¢è¿", "æ‘†å¸ƒ", "åŒå€", "è¿‡å¹´", "å¤®æ±‚", "å¤©åˆ†", "ç”µç¯æ³¡"] 
        },
        { 
            name: "ç¬¬20è¯¾ï¼šè‚¥çš‚æ³¡", 
            words: ["è‚¥çš‚", "èµ°å»Š", "å‰©ä¸‹", "é¥­ç¢—", "æ‚ é—²", "è‹¥æ˜¯", "é€æ˜", "å¨‡è½¯", "æ‹‰æ‰¯", "ä»°å¤´", "ä¸€ä¸²", "å©´å„¿", "å¸Œæœ›", "ç§ç±»", "å…¶ä¸­", "ç½‘çƒ", "åˆ†è£‚", "å½¢å¼", "åœ†æ»¡", "è½»æ‚ æ‚ ", "é£è¶Š", "ç›®é€"] 
        },
        { 
            name: "ç¬¬22è¯¾ï¼šæˆ‘ä»¬å¥‡å¦™çš„ä¸–ç•Œ", 
            words: ["å‘ˆç°", "å˜å¹»", "è¯±äºº", "åœ†æ¶¦", "å…‰èŠ’", "å†°æŸ±", "åˆ€å‰‘", "æ™®é€š", "æ¨¡å‹", "å¥‡å¦™", "ç¾¤æ˜Ÿ", "å¥‡è¿¹", "æ„Ÿå¹", "é”‹åˆ©", "å­˜åœ¨"] 
        },
        { 
            name: "ç¬¬23è¯¾ï¼šæµ·åº•ä¸–ç•Œ", 
            words: ["å®é™", "å™¨å®˜", "æ±ªæ´‹", "å‚åŠ ", "æ”»å‡»", "æ¨å¼€", "è¿…é€Ÿ", "åé€€", "è½®èˆ¹", "ç…¤ç‚­", "é’¢é“", "æµ·åº•", "è¡Œè¿›", "æµ·å‚", "åæ¨åŠ›", "é•¿é€”", "çŸ³æ²¹", "å¤©ç„¶æ°”"] 
        },
        { 
            name: "ç¬¬24è¯¾ï¼šç«çƒ§äº‘", 
            words: ["å¿…é¡»", "èƒ¡å­", "ç¿çƒ‚", "éª‘é©¬", "ç§’è¡¨", "è…¿è„š", "å‡¶çŒ›", "æ¥ç€", "å¯ºåº™", "å¨æ­¦", "é•‡é™", "ç«çƒ§äº‘", "æ™šé¥­", "é‡‘ç¿ç¿"] 
        },
        { 
            name: "ç¬¬25è¯¾ï¼šæ…¢æ€§å­è£ç¼å’Œæ€¥æ€§å­é¡¾å®¢", 
            words: ["æ€§å­", "è¯•å·", "è´§ç‰©", "å¤¹è¢„", "å¤¸å¥–", "æœåŠ¡", "è¡¬è¡«", "è´Ÿè´£", "æ‰‹è‰º", "å¸ƒæ–™", "äº¤è´§", "ç¬‘è¯", "å¤§æ–¹", "é“ç†", "å®åœ¨", "æå‰", "åå£°", "æ„ŸåŠ¨"] 
        },
        { 
            name: "ç¬¬27è¯¾ï¼šæ¼", 
            words: ["æ¼é›¨", "å–‚çŒª", "è‚¥èƒ–", "æ¯›é©´", "ç›—è´¼", "æ¶ç‹¼", "è«é", "å‰å®³", "æ‹¥æŠ±", "ä¹¦æ¶", "èƒ¶æ°´", "ç²˜è´´", "åå¿ƒ", "é‡Œå±‹", "å‘æŠ–", "æ¾æ‰‹", "è·Ÿå‰", "ç”˜å¿ƒ"] 
        }
    ];

    const quotes = {
        start: ["å°æ ‘è‹—ï¼Œå¿«å¿«é•¿ï¼", "åå§¿ç«¯æ­£ï¼Œå­—è¿¹å·¥æ•´ã€‚", "ä¸€ç¬”ä¸€åˆ’ï¼Œå†™å‡ºç²¾å½©ï¼", "è®¤çœŸå¬å†™ï¼Œä½ æœ€æ£’ï¼"],
        half: ["å¤ªå¥½äº†ï¼Œå·²ç»åšæŒä¸€åŠå•¦ï¼", "åŠ æ²¹åŠ æ²¹ï¼Œä½ æ˜¯å°å‹‡å£«ï¼", "ä¿æŒä¸“æ³¨ï¼Œèƒœåˆ©åœ¨æœ›ï¼"],
        end: ["æŒ‘æˆ˜æˆåŠŸï¼ç»™è‡ªå·±ä¸€ä¸ªå¤§å¤§çš„èµï¼", "ä½ å­¦ä¼šäº†å¥½å¤šæ–°è¯è¯­ï¼ŒçœŸå‰å®³ï¼"]
    };

    // --- å…¨å±€å˜é‡ ---
    let currentSessionList = [];
    let currentIndex = 0;
    let isRunning = false;
    let isPaused = false;
    let synth = window.speechSynthesis;
    
    // ğŸ”¥ iOS å…³é”®ä¿®å¤ï¼šå®šä¹‰å…¨å±€ utterance å˜é‡ï¼Œé˜²æ­¢è¢«åƒåœ¾å›æ”¶
    let currentUtterance = null;
    let chineseVoice = null;

    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    // --- åˆå§‹åŒ– ---
    window.onload = function() {
        initLessonSelector();
        updateMotivation(quotes.start[Math.floor(Math.random()*quotes.start.length)]);
        
        // æ£€æµ‹ iOS å¹¶æ˜¾ç¤ºæç¤º
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        if (isIOS) {
            document.getElementById('iosTip').style.display = 'block';
        }

        // å°è¯•é¢„åŠ è½½è¯­éŸ³
        loadVoices();
        if (synth.onvoiceschanged !== undefined) {
            synth.onvoiceschanged = loadVoices;
        }
    }

    function loadVoices() {
        const voices = synth.getVoices();
        // ä¼˜å…ˆæ‰¾ä¸­æ–‡è¯­éŸ³
        chineseVoice = voices.find(v => v.lang === 'zh-CN' || v.lang === 'zh-HK' || v.name.includes('Ting'));
    }

    function initLessonSelector() {
        const select = document.getElementById('lessonSelect');
        select.innerHTML = '';
        lessonGroups.forEach((group, index) => {
            const option = document.createElement('option');
            option.value = index;
            const uniqueCount = new Set(group.words).size;
            option.text = `${group.name} [${uniqueCount}è¯]`;
            select.appendChild(option);
        });
        if(lessonGroups.length > 0) previewWords();
    }

    function previewWords() {
        const index = document.getElementById('lessonSelect').value;
        const words = lessonGroups[index].words;
        const uniqueWords = [...new Set(words)];
        const list = document.getElementById('wordPreview');
        let html = '<div class="answer-grid">';
        uniqueWords.forEach((w, i) => {
            html += `<div class="answer-item"><span style="font-size:0.7em;color:#aaa;display:block">${i+1}</span>${w}</div>`;
        });
        html += '</div>';
        list.innerHTML = html;
    }

    function toggleCustomArea() {
        const area = document.getElementById('customInputArea');
        area.style.display = area.style.display === 'none' ? 'block' : 'none';
    }

    function updateMotivation(text) {
        const box = document.getElementById('motivationBox');
        box.style.opacity = 0;
        setTimeout(() => { box.innerText = text; box.style.opacity = 1; }, 300);
    }

    // --- å¬å†™é€»è¾‘ ---

    function initDictation() {
        // ğŸ”¥ iOS æ ¸å¿ƒä¿®å¤ 1ï¼šåœ¨ç”¨æˆ·ç‚¹å‡»ç¬é—´ï¼Œå¿…é¡»è§¦å‘ä¸€æ¬¡ synth.speak
        synth.cancel();
        const warmUp = new SpeechSynthesisUtterance('');
        synth.speak(warmUp);

        const customInput = document.getElementById('customWordInput').value.trim();
        let sessionName = "";

        if (customInput.length > 0) {
            currentSessionList = processTextToWords(customInput);
            if(currentSessionList.length === 0) { alert("æ— æ•ˆçš„è¯è¯­è¾“å…¥"); return; }
            sessionName = "è‡ªå®šä¹‰æŒ‘æˆ˜";
        } else {
            const index = document.getElementById('lessonSelect').value;
            currentSessionList = [...new Set(lessonGroups[index].words)];
            sessionName = lessonGroups[index].name;
        }

        document.getElementById('setupArea').style.display = 'none';
        document.getElementById('runningArea').style.display = 'block';
        document.getElementById('answerList').style.display = 'none';
        document.getElementById('answerList').innerHTML = '';
        document.getElementById('currentLevelName').innerText = sessionName;

        startSession();
    }

    function processTextToWords(text) {
        const extracted = text.match(/[\u4e00-\u9fa5]+/g);
        if (!extracted) return [];
        return [...new Set(extracted.filter(w => w.length >= 1))];
    }

    // --- æ ¸å¿ƒå¾ªç¯ ---
    async function startSession() {
        isRunning = true;
        isPaused = false;
        currentIndex = 0;
        document.getElementById('pauseBtn').innerText = 'æš‚åœ';
        
        const display = document.getElementById('wordDisplay');
        const status = document.getElementById('statusMsg');
        
        // å€’è®¡æ—¶
        status.innerText = "å‡†å¤‡å¼€å§‹...";
        for(let i=3; i>0; i--) {
            display.innerText = i;
            await sleep(1000);
        }

        const total = currentSessionList.length;

        while (currentIndex < total && isRunning) {
            updateProgress();
            
            if (currentIndex === Math.floor(total / 2)) {
                updateMotivation(quotes.half[Math.floor(Math.random()*quotes.half.length)]);
            }

            await checkPause();
            if (!isRunning) break;

            const word = currentSessionList[currentIndex];
            
            display.style.animation = 'none';
            display.offsetHeight; 
            display.style.animation = 'popIn 0.5s';
            
            display.innerText = `ç¬¬ ${currentIndex + 1} ä¸ª`;
            display.style.color = '#064e3b';
            status.innerText = 'æ­£åœ¨æœ—è¯»...';

            const repeat = parseInt(document.getElementById('repeatCount').value);
            for (let r=0; r < repeat; r++) {
                await checkPause(); 
                if (!isRunning) break;
                
                await speakWord(word); // ç­‰å¾…æœ—è¯»å®Œæˆ
                
                if (r < repeat - 1) await sleep(1200); 
            }

            if (!isRunning) break;
            status.innerText = 'è¯·ä¹¦å†™...';
            display.style.color = '#e2e8f0'; 
            
            const waitTime = parseInt(document.getElementById('waitTime').value) * 10; 
            for(let t=0; t<waitTime; t++) { 
                await checkPause();
                if (!isRunning) break;
                await sleep(100);
            }

            currentIndex++;
        }

        if (isRunning) {
            finishDictation();
        }
    }

    // ğŸ”¥ iOS æ ¸å¿ƒä¿®å¤ 2ï¼šè¯­éŸ³åˆæˆ Promise å°è£…
    function speakWord(text) {
        return new Promise((resolve) => {
            // å…ˆåœæ­¢ä¹‹å‰çš„
            synth.cancel();

            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'zh-CN';
            
            if (chineseVoice) {
                u.voice = chineseVoice;
            }

            const selectedRate = document.getElementById('speechRate').value;
            u.rate = parseFloat(selectedRate);
            
            // ğŸ”¥ å…³é”®ï¼šå°† utterance èµ‹å€¼ç»™å…¨å±€å˜é‡
            currentUtterance = u;

            u.onend = () => {
                currentUtterance = null; 
                resolve();
            };

            u.onerror = (e) => {
                console.error("Speech error", e);
                currentUtterance = null;
                resolve();
            };

            synth.speak(u);

            // ğŸ”¥ iOS æ ¸å¿ƒä¿®å¤ 3ï¼šè¶…æ—¶å¼ºåˆ¶è·³è¿‡ (4ç§’)
            setTimeout(() => {
                if (currentUtterance === u) {
                    console.log("iOS timeout fallback");
                    resolve();
                }
            }, 4000); 
        });
    }

    function updateProgress() {
        const total = currentSessionList.length;
        document.getElementById('progressText').innerText = `è¿›åº¦: ${currentIndex} / ${total}`;
        const pct = ((currentIndex) / total) * 100;
        document.getElementById('progressFill').style.width = `${pct}%`;
    }

    async function checkPause() {
        while (isPaused && isRunning) {
            await sleep(200);
        }
    }

    function togglePause() {
        isPaused = !isPaused;
        const btn = document.getElementById('pauseBtn');
        if (isPaused) {
            synth.cancel(); 
            btn.innerText = 'ç»§ç»­';
            btn.style.background = "#d1fae5";
            btn.style.color = "#064e3b";
            document.getElementById('statusMsg').innerText = 'â¸ å·²æš‚åœ';
        } else {
            btn.innerText = 'æš‚åœ';
            btn.style.background = "#ecfdf5";
            btn.style.color = "#047857";
        }
    }

    function stopDictation() {
        if(confirm("ç¡®å®šè¦ç»“æŸå—ï¼Ÿ")) {
            isRunning = false;
            synth.cancel();
            document.getElementById('runningArea').style.display = 'none';
            document.getElementById('setupArea').style.display = 'block';
            updateMotivation("æ²¡å…³ç³»ï¼Œä¸‹æ¬¡ç»§ç»­ï¼");
        }
    }

    function finishDictation() {
        const display = document.getElementById('wordDisplay');
        display.innerHTML = '<div style="animation:popIn 0.6s"><span style="font-size:3rem;display:inline-block;animation:float 2s infinite">ğŸŒŸ</span><br>å®Œæˆ!</div>';
        display.style.fontSize = "2rem";
        document.getElementById('statusMsg').innerText = "å¤ªæ£’äº†ï¼å¿«æ£€æŸ¥ä¸€ä¸‹ï¼";
        
        document.getElementById('progressFill').style.width = '100%';
        document.getElementById('progressText').innerText = "100%";
        updateMotivation(quotes.end[Math.floor(Math.random()*quotes.end.length)]);

        const list = document.getElementById('answerList');
        let html = '<h3 style="margin-bottom:15px; color:#059669; text-align:center;">ğŸ† ç­”æ¡ˆæ ¸å¯¹å¡</h3><div class="answer-grid">';
        currentSessionList.forEach((w, i) => {
            html += `<div class="answer-item"><span style="font-size:0.7em;color:#aaa;display:block">${i+1}</span>${w}</div>`;
        });
        html += '</div><div style="text-align:center; margin-top:20px;"><button class="control-btn" onclick="location.reload()" style="background:#10b981;color:white;">å†æ¥ä¸€å±€</button></div>';
        
        list.innerHTML = html;
        list.style.display = 'block';
        document.querySelector('.control-btns').style.display = 'none';
        
        setTimeout(() => { list.scrollIntoView({ behavior: 'smooth' }); }, 500);
    }

    async function handlePdfUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        const statusEl = document.getElementById('ocrStatus');
        statusEl.innerText = 'â³ æ­£åœ¨è§£æ...';
        try {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            let fullText = '';
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                fullText += textContent.items.map(item => item.str).join(' ');
            }
            document.getElementById('customWordInput').value = fullText;
            statusEl.innerText = 'âœ… è§£ææˆåŠŸ';
        } catch (e) {
            console.error(e);
            statusEl.innerText = 'âŒ è§£æå¤±è´¥';
        }
    }

    function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

</script>
</body>
</html>
